<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ° èŒè¶£ä¸­è‹±æ–‡çŸ­è¯­å¬å†™åŠ©æ‰‹</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Microsoft YaHei", "å¹¼åœ†", sans-serif;
            max-width: 800px; margin: 15px auto; text-align: center;
            background: linear-gradient(135deg, #fdf6f8 0%, #e9f5ff 100%); padding: 15px;
        }
        .header {
            background: #fff; border-radius: 20px; padding: 18px; margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(255, 182, 193, 0.2); border: 2px solid #ffd1dc;
        }
        .header h1 {
            color: #ff6b9d; font-size: 1.8rem; margin-bottom: 8px;
            display: flex; align-items: center; justify-content: center; gap: 12px;
        }
        .header h1 span { font-size: 2rem; }
        .header p { color: #6a994e; font-size: 0.95rem; font-weight: 500; }
        .main-area {
            background: #fff; border-radius: 25px; padding: 25px 15px; margin: 18px 0;
            box-shadow: 0 6px 15px rgba(173, 216, 230, 0.3); border: 3px solid #bde0fe;
        }
        .unit-label {
            font-size: 1.2rem; color: #4a7c59; margin-bottom: 12px; font-weight: bold;
            background: #f1faee; display: inline-block; padding: 5px 15px; border-radius: 30px;
        }
        .word-display {
            font-size: 2.2rem; font-weight: bold; color: #264653; margin: 20px 0; padding: 20px;
            background: #f8f9fa; border-radius: 15px; border: 2px dashed #ffc8dd;
            min-height: 120px; display: flex; align-items: center; justify-content: center;
        }
        .timer {
            font-size: 2.2rem; color: #ff758f; margin: 12px 0; font-weight: bold;
            text-shadow: 1px 1px 2px rgba(255,117,143,0.2);
        }
        .control-btn {
            padding: 10px 25px; font-size: 1rem; margin: 6px; border: none; border-radius: 30px;
            cursor: pointer; color: white; font-weight: 500; transition: all 0.3s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        .start-btn { background: #ff9a8b; }
        .start-btn:hover { background: #ff6b6b; transform: translateY(-2px); }
        .reset-btn { background: #74c69d; }
        .reset-btn:hover { background: #52b788; transform: translateY(-2px); }
        .switch-btn { background: #7b66ff; }
        .switch-btn:hover { background: #6344ff; transform: translateY(-2px); }
        .language-btn { background: #9d4edd; }
        .language-btn:hover { background: #7b2cbf; transform: translateY(-2px); }
        .func-area {
            margin: 20px 0; padding: 20px; background: #fff; border-radius: 20px;
            box-shadow: 0 4px 12px rgba(255, 218, 185, 0.25); border: 2px solid #fefae0;
        }
        .area-title {
            font-size: 1.3rem; color: #264653; margin-bottom: 15px; font-weight: bold;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .upload-area .area-title { color: #e76f51; }
        .upload-area .func-btn { background: #f4a261; }
        .upload-area .func-btn:hover { background: #e9c46a; transform: scale(1.03); }
        .check-area .area-title { color: #2a9d8f; }
        .check-area .func-btn { background: #264653; }
        .check-area .func-btn:hover { background: #2a9d8f; transform: scale(1.03); }
        .func-btn {
            padding: 9px 22px; font-size: 1rem; margin: 6px; border: none; border-radius: 30px;
            cursor: pointer; color: white; font-weight: 500; transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .func-btn:disabled {
            background: #d1d1d1; cursor: not-allowed; transform: none;
        }
        .photo-preview {
            max-width: 280px; height: auto; margin: 10px auto;
            border: 3px dashed #ffd6a5; border-radius: 12px; display: none;
            padding: 5px;
        }
        .file-input { display: none; }
        .result-area {
            margin-top: 18px; text-align: left; max-height: 280px; overflow-y: auto;
            padding: 15px; background: #f9f9f9; border-radius: 12px; border: 2px solid #e9ecef;
            font-size: 0.95rem; line-height: 1.6;
        }
        .correct { color: #27ae60; font-weight: bold; }
        .wrong { color: #e74c3c; font-weight: bold; }
        .accuracy {
            font-size: 1rem; margin-top: 12px; color: #264653; font-weight: bold;
            background: #f1faee; padding: 8px 12px; border-radius: 8px;
        }
        .word-list-tip {
            color: #e76f51; font-size: 0.9rem; margin-top: 10px; padding: 8px 12px;
            background: #fff3e6; border-radius: 8px; display: inline-block; max-width: 90%;
        }
        .tip {
            color: #6c757d; font-size: 0.9rem; margin: 15px 0; line-height: 1.6;
            background: #f8f9fa; padding: 10px; border-radius: 12px; border: 1px solid #e9ecef;
        }
        .loading { color: #7b66ff; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h1><span>ğŸ°</span> èŒè¶£ä¸­è‹±æ–‡çŸ­è¯­å¬å†™åŠ©æ‰‹ <span>ğŸ±</span></h1>
        <p>ğŸŒŸ æ™ºèƒ½å‡€åŒ–æ–‡æœ¬ï½œç²¾å‡†ä¸­è‹±æ–‡è¯†åˆ«ï½œè‡ªç”±åˆ‡æ¢æŠ¥è¯»è¯­è¨€</p>
    </div>

    <div class="main-area">
        <div class="unit-label" id="unitLabel">å½“å‰ï¼šé»˜è®¤çŸ­è¯­å¬å†™</div>
        <div class="word-display" id="wordDisplay">å‡†å¤‡å¼€å§‹å¬å†™å•¦ï½</div>
        <div class="timer" id="timer">6</div>
        <button id="languageToggleBtn" class="control-btn language-btn">ğŸ”Š æŠ¥è¯»æ¨¡å¼ï¼šè‹±æ–‡</button>
        <button id="startBtn" class="control-btn start-btn">ğŸˆ å¼€å§‹å¬å†™</button>
        <button id="resetBtn" class="control-btn reset-btn">ğŸ”„ é‡ç½®</button>
        <button id="switchUnitBtn" class="control-btn switch-btn">ğŸ”– åˆ‡æ¢é»˜è®¤çŸ­è¯­</button>
    </div>

    <div class="func-area upload-area">
        <div class="area-title">ğŸ“š æ‹ç…§æå–çŸ­è¯­ï¼ˆæ”¯æŒä¸­è‹±æ–‡ï¼‰</div>
        <input type="file" accept="image/*" capture="environment" class="file-input" id="wordFileInput">
        <button id="uploadWordBtn" class="func-btn">ğŸ“¸ ä¸Šä¼ çŸ­è¯­è¡¨å›¾ç‰‡</button>
        <button id="confirmWordBtn" class="func-btn" disabled>âœ… ç¡®è®¤å¯¼å…¥çŸ­è¯­</button>
        <img id="uploadPreview" class="photo-preview" alt="å¯¼å…¥çŸ­è¯­ç…§ç‰‡é¢„è§ˆ">
        <p class="word-list-tip" id="extractedWordTip">ç­‰å¾…æå–çŸ­è¯­ï½</p>
    </div>

    <div class="func-area check-area">
        <div class="area-title">âœï¸ æˆ‘çš„å¬å†™ï½œæ‹ç…§æ‰¹æ”¹å‡ºç»“æœ</div>
        <input type="file" accept="image/*" capture="environment" class="file-input" id="checkFileInput">
        <button id="takePhotoBtn" class="func-btn">ğŸ“· ä¸Šä¼ æˆ‘çš„é»˜å†™çº¸</button>
        <button id="checkBtn" class="func-btn" disabled>ğŸŒŸ å¼€å§‹æ‰¹æ”¹æ‰“åˆ†</button>
        <img id="checkPreview" class="photo-preview" alt="æ‰¹æ”¹ç…§ç‰‡é¢„è§ˆ">
        <div class="result-area" id="correctResult"></div>
    </div>

    <p class="tip">ğŸ’¡ ä½¿ç”¨å°æç¤ºï¼š<br>
        1. <b>æŠ¥è¯»æ¨¡å¼</b>ï¼šç‚¹å‡»ä¸Šæ–¹ç´«è‰²æŒ‰é’®ï¼Œå¯åœ¨ã€Œä¸­æ–‡ã€å’Œã€Œè‹±æ–‡ã€æœ—è¯»é—´åˆ‡æ¢ã€‚<br>
        2. <b>æ™ºèƒ½å‡€åŒ–</b>ï¼šæœ—è¯»æ—¶ä¼šè‡ªåŠ¨è¿‡æ»¤ç¼–å·ï¼ˆå¦‚â€œ10.â€ï¼‰ã€è¯æ€§ï¼ˆå¦‚â€œv.â€â€œn.â€ï¼‰å’Œä¸­æ–‡é‡Šä¹‰ã€‚<br>
        3. <b>ç²¾å‡†è¯†åˆ«</b>ï¼šç³»ç»Ÿå·²ä¼˜åŒ–ï¼Œèƒ½è‡ªåŠ¨ä¿®å¤ä¸­æ–‡è¯è¯­ä¸­é—´è¢«ä¸å½“ç©ºæ ¼æ–­å¼€çš„é—®é¢˜ã€‚<br>
        4. <b>æ‹ç…§è¦ç‚¹</b>ï¼šå…‰çº¿å……è¶³ã€å¯¹å‡†ç„¦ã€å­—è¿¹æ¸…æ™°ï¼Œè¯†åˆ«æ•ˆæœæ›´ä½³ã€‚</p>

    <script>
        // ========== åŸºç¡€æ•°æ® ==========
        const unit1 = [
            "buy pretty clothes", "need a new coat", "a long zip",
            "some lovely buttons", "a useful pocket", "the blouse with buttons",
            "the jacket with a zip", "the sweater with pockets", "put on her shoes",
            "take off the gloves"
        ];
        const unit2 = [
            "wear a dress", "a pair of jeans", "a warm scarf",
            "a comfortable hat", "tie your shoelaces", "a colorful skirt",
            "a soft sweater", "a stylish shirt", "put on your socks",
            "take off your hat"
        ];

        // ========== æ ¸å¿ƒå˜é‡ ==========
        let speechLanguage = 'en-US'; // è¯­éŸ³åˆæˆè¯­è¨€ï¼š'en-US' è‹±æ–‡, 'zh-CN' ä¸­æ–‡
        let currentLanguageMode = 'è‹±æ–‡';
        let currentUnit = unit1;
        let customWordList = [];
        let isCustomMode = false;
        let currentWordIndex = 0;
        let timerInterval = null;
        let timeLeft = 6;
        let isRunning = false;
        let uploadPhotoData = null;
        let checkPhotoData = null;

        const unit1Pure = unit1.map(w => w.toLowerCase());
        const unit2Pure = unit2.map(w => w.toLowerCase());
        let currentPureList = unit1Pure;

        // ========== DOM å…ƒç´  ==========
        const el = id => document.getElementById(id);
        const wordDisplay = el('wordDisplay'), timerDisplay = el('timer'), startBtn = el('startBtn');
        const resetBtn = el('resetBtn'), switchUnitBtn = el('switchUnitBtn'), unitLabel = el('unitLabel');
        const uploadWordBtn = el('uploadWordBtn'), confirmWordBtn = el('confirmWordBtn'), uploadPreview = el('uploadPreview');
        const extractedWordTip = el('extractedWordTip'), takePhotoBtn = el('takePhotoBtn'), checkBtn = el('checkBtn');
        const checkPreview = el('checkPreview'), correctResult = el('correctResult');
        const wordFileInput = el('wordFileInput'), checkFileInput = el('checkFileInput');
        const languageToggleBtn = el('languageToggleBtn');

        // ========== ã€æ–°å¢ã€‘æ ¸å¿ƒæ–‡æœ¬å¤„ç†å‡½æ•° ==========
        /**
         * 1. æ¸…æ´—æœ—è¯»æ–‡æœ¬ï¼šå»é™¤ç¼–å·ã€è¯æ€§æ ‡æ³¨ã€ä¸­æ–‡é‡Šä¹‰ï¼Œè¿”å›çº¯å‡€çš„æ ¸å¿ƒå•è¯æˆ–ä¸­æ–‡
         * è¾“å…¥ç¤ºä¾‹ï¼š"10. slide v.æ»‘è½ n.æ»‘åŠ¨ï¼›å¹»ç¯ç‰‡"
         * è¾“å‡ºç¤ºä¾‹ï¼š"slide" (è‹±æ–‡æ¨¡å¼) æˆ– "æ»‘è½" (ä¸­æ–‡æ¨¡å¼)
         */
        function cleanTextForSpeech(text) {
            let cleaned = text.trim();
            // 1. å»é™¤è¡Œé¦–æ•°å­—ç¼–å· (å¦‚ "10."ï¼Œ "11. ")
            cleaned = cleaned.replace(/^\d+\.\s*/, '');
            // 2. å»é™¤è‹±æ–‡è¯æ€§æ ‡æ³¨åŠç´§è·Ÿçš„ä¸­æ–‡é‡Šä¹‰ (å¦‚ "v.æ»‘è½ n.æ»‘åŠ¨ï¼›")
            cleaned = cleaned.replace(/[a-z]+\.[^a-z]*/gi, '');
            // 3. å»é™¤å¤šä½™ç©ºæ ¼å’Œç‰¹æ®Šåˆ†éš”ç¬¦
            cleaned = cleaned.replace(/\s+/g, ' ').replace(/[ï¼›ã€‚ï¼Œã€]/g, ' ').trim();
            // 4. æå–æ ¸å¿ƒï¼šè¿ç»­çš„è‹±æ–‡å­—æ¯ æˆ– è¿ç»­çš„ä¸­æ–‡å­—ç¬¦
            const coreMatch = cleaned.match(/([a-zA-Z]+|[\u4e00-\u9fa5]+)/g);
            if (coreMatch) {
                // æ ¹æ®å½“å‰è¯­éŸ³æ¨¡å¼å†³å®šè¿”å›è‹±æ–‡éƒ¨åˆ†è¿˜æ˜¯ä¸­æ–‡éƒ¨åˆ†
                if (speechLanguage === 'zh-CN') {
                    // ä¸­æ–‡æ¨¡å¼ï¼šä¼˜å…ˆè¿”å›ç¬¬ä¸€ä¸ªä¸­æ–‡å­—æ®µï¼Œè‹¥æ— åˆ™è¿”å›ç¬¬ä¸€ä¸ªå­—æ®µ
                    const chinesePart = coreMatch.find(chunk => /[\u4e00-\u9fa5]/.test(chunk));
                    cleaned = chinesePart || coreMatch[0];
                } else {
                    // è‹±æ–‡æ¨¡å¼ï¼šä¼˜å…ˆè¿”å›ç¬¬ä¸€ä¸ªè‹±æ–‡å­—æ®µï¼Œè‹¥æ— åˆ™è¿”å›ç¬¬ä¸€ä¸ªå­—æ®µ
                    const englishPart = coreMatch.find(chunk => /[a-zA-Z]/.test(chunk));
                    cleaned = englishPart || coreMatch[0];
                }
            }
            return cleaned || text; // å¦‚æœæ¸…æ´—åä¸ºç©ºï¼Œåˆ™è¿”å›åŸæ–‡æœ¬
        }

        /**
         * 2. ä¼˜åŒ–OCRè¯†åˆ«å‡ºçš„ä¸­æ–‡æ–‡æœ¬ï¼šä¿®å¤ä¸­æ–‡è¯è¯­ä¸­é—´ä¸å½“çš„ç©ºæ ¼
         * è¾“å…¥ç¤ºä¾‹ï¼š"å¹»ç¯ ç‰‡è¯†åˆ« æ•ˆæœ"
         * è¾“å‡ºç¤ºä¾‹ï¼š"å¹»ç¯ç‰‡è¯†åˆ«æ•ˆæœ"
         */
        function optimizeChineseText(text) {
            let optimized = text;
            // æ ¸å¿ƒï¼šç§»é™¤è¿ç»­ä¸­æ–‡å­—ç¬¦ä¹‹é—´ä¸å¿…è¦çš„ç©ºæ ¼
            optimized = optimized.replace(/([\u4e00-\u9fa5])\s+([\u4e00-\u9fa5])/g, '$1$2');
            // æ¸…ç†å› OCRäº§ç”Ÿçš„å…¶ä»–å¸¸è§éå­—æ¯æ•°å­—å­—ç¬¦ç²˜è¿
            optimized = optimized.replace(/([\u4e00-\u9fa5])[^a-zA-Z0-9\u4e00-\u9fa5\s]+([\u4e00-\u9fa5])/g, '$1$2');
            return optimized.trim();
        }

        // ========== è¯­éŸ³ä¸è®¡æ—¶åŠŸèƒ½ ==========
        function readWordThreeTimes(wordText) {
            const rawPhrase = wordText.trim();
            // å…³é”®ï¼šæœ—è¯»å‰å…ˆæ¸…æ´—æ–‡æœ¬
            const cleanedPhrase = cleanTextForSpeech(rawPhrase);
            window.speechSynthesis.cancel();
            setTimeout(() => speakWord(cleanedPhrase), 0);
            setTimeout(() => speakWord(cleanedPhrase), 1000);
            setTimeout(() => speakWord(cleanedPhrase), 2000);
        }

        function speakWord(word) {
            const speech = new SpeechSynthesisUtterance(word);
            speech.lang = speechLanguage;
            speech.volume = 1;
            speech.rate = speechLanguage === 'zh-CN' ? 0.7 : 0.45;
            speech.pitch = 1;
            window.speechSynthesis.speak(speech);
        }

        function startTimer() {
            timeLeft = 6; timerDisplay.textContent = timeLeft;
            timerInterval = setInterval(() => {
                timeLeft--; timerDisplay.textContent = timeLeft;
                if (timeLeft <= 0) { clearInterval(timerInterval); nextWord(); }
            }, 1000);
        }

        function nextWord() {
            currentWordIndex++;
            if (currentWordIndex < currentUnit.length) {
                const phrase = currentUnit[currentWordIndex];
                wordDisplay.textContent = phrase;
                readWordThreeTimes(phrase);
                startTimer();
            } else {
                wordDisplay.textContent = "ğŸ‰ å¬å†™å…¨éƒ¨å®Œæˆå•¦ï¼";
                timerDisplay.textContent = "0";
                isRunning = false;
                startBtn.disabled = false;
                confirmWordBtn.disabled = false;
            }
        }

        // ========== äº¤äº’äº‹ä»¶ç›‘å¬ ==========
        // 1. è¯­è¨€åˆ‡æ¢
        languageToggleBtn.addEventListener('click', function() {
            if (speechLanguage === 'en-US') {
                speechLanguage = 'zh-CN';
                currentLanguageMode = 'ä¸­æ–‡';
                this.textContent = 'ğŸ”Š æŠ¥è¯»æ¨¡å¼ï¼šä¸­æ–‡';
                this.style.background = '#ffaa00';
            } else {
                speechLanguage = 'en-US';
                currentLanguageMode = 'è‹±æ–‡';
                this.textContent = 'ğŸ”Š æŠ¥è¯»æ¨¡å¼ï¼šè‹±æ–‡';
                this.style.background = '#9d4edd';
            }
        });

        // 2. ä¸Šä¼ å¹¶è¯†åˆ«çŸ­è¯­è¡¨å›¾ç‰‡
        uploadWordBtn.addEventListener('click', () => wordFileInput.click());
        wordFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadPhotoData = e.target.result;
                uploadPreview.src = uploadPhotoData;
                uploadPreview.style.display = 'block';
                extractedWordTip.textContent = 'â³ æ­£åœ¨è¯†åˆ«å›¾ç‰‡ä¸­çš„çŸ­è¯­...';
                extractedWordTip.classList.add('loading');
                confirmWordBtn.disabled = true;
            };
            reader.readAsDataURL(file);

            try {
                // ã€å…³é”®ä¿®æ”¹ã€‘ä½¿ç”¨ä¼˜åŒ–åçš„è¯­è¨€åŒ…å’Œæ–‡æœ¬å¤„ç†
                const { data: { text } } = await Tesseract.recognize(file, 'eng+chi_sim', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            extractedWordTip.textContent = `â³ è¯†åˆ«è¿›åº¦: ${Math.round(m.progress * 100)}%`;
                        }
                    }
                });

                // ã€å…³é”®ä¿®æ”¹ã€‘å¯¹è¯†åˆ«å‡ºçš„åŸå§‹æ–‡æœ¬è¿›è¡Œä¼˜åŒ–ï¼Œä¿®å¤ä¸­æ–‡ç©ºæ ¼
                let optimizedText = optimizeChineseText(text);
                customWordList = optimizedText
                    .split(/\n/)
                    .map(line => line.trim())
                    .filter(line => line.length >= 1);
                customWordList = [...new Set(customWordList)]; // å»é‡

                if (customWordList.length > 0) {
                    extractedWordTip.innerHTML = `âœ¨ æå–æˆåŠŸï¼å…± <strong>${customWordList.length}</strong> æ¡å†…å®¹ã€‚<br>å‰å‡ é¡¹ï¼š${customWordList.slice(0, 5).join('ã€')}${customWordList.length > 5 ? '...' : ''}`;
                    extractedWordTip.classList.remove('loading');
                    confirmWordBtn.disabled = false;
                } else {
                    extractedWordTip.textContent = 'ğŸ˜¥ æ²¡æœ‰è¯†åˆ«åˆ°æœ‰æ•ˆæ–‡æœ¬ï¼Œè¯·æ¢ä¸€å¼ æ›´æ¸…æ™°çš„å›¾ç‰‡è¯•è¯•å§ï½';
                    extractedWordTip.classList.remove('loading');
                    confirmWordBtn.disabled = true;
                }
            } catch (err) {
                console.error('OCR Error:', err);
                extractedWordTip.textContent = 'ğŸ˜¥ è¯†åˆ«å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–å›¾ç‰‡ã€‚';
                extractedWordTip.classList.remove('loading');
                confirmWordBtn.disabled = true;
            }
        });

        // 3. ç¡®è®¤å¯¼å…¥è‡ªå®šä¹‰çŸ­è¯­
        confirmWordBtn.addEventListener('click', () => {
            if (customWordList.length === 0) return;
            isCustomMode = true;
            currentUnit = customWordList;
            currentPureList = customWordList.map(w => w.toLowerCase().replace(/[^a-z\u4e00-\u9fa5]/g, ''));
            unitLabel.textContent = `å½“å‰ï¼šè‡ªå®šä¹‰åˆ—è¡¨ï¼ˆå…±${customWordList.length}æ¡ï¼‰`;
            resetBtn.click();
            alert('ğŸŠ è‡ªå®šä¹‰å†…å®¹å¯¼å…¥æˆåŠŸï¼ç‚¹å‡»ã€å¼€å§‹å¬å†™ã€‘å°±èƒ½ä½¿ç”¨å•¦ï½');
        });

        // 4. ä¸Šä¼ é»˜å†™çº¸å›¾ç‰‡
        takePhotoBtn.addEventListener('click', () => checkFileInput.click());
        checkFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                checkPhotoData = e.target.result;
                checkPreview.src = checkPhotoData;
                checkPreview.style.display = 'block';
                checkBtn.disabled = false;
                correctResult.innerHTML = '<p class="loading">ğŸ–¼ï¸ å›¾ç‰‡å·²ä¸Šä¼ ï¼Œç‚¹å‡»ã€å¼€å§‹æ‰¹æ”¹æ‰“åˆ†ã€‘è¿›è¡Œåˆ†æ...</p>';
            };
            reader.readAsDataURL(file);
        });

        // 5. æ‰¹æ”¹åŠŸèƒ½
        checkBtn.addEventListener('click', async () => {
            if (!checkPhotoData) { alert('è¯·å…ˆä¸Šä¼ é»˜å†™çº¸å›¾ç‰‡å“¦ï½'); return; }
            if (currentPureList.length === 0) { alert('è¯·å…ˆå¼€å§‹å¬å†™æˆ–å¯¼å…¥çŸ­è¯­åˆ—è¡¨ï½'); return; }

            try {
                correctResult.innerHTML = '<p class="loading">ğŸ” æ­£åœ¨æ‰¹æ”¹ï¼Œè¯·ç¨å€™...</p>';
                const file = checkFileInput.files[0];
                // ã€å…³é”®ä¿®æ”¹ã€‘ä½¿ç”¨ä¼˜åŒ–åçš„è¯­è¨€åŒ…å’Œæ–‡æœ¬å¤„ç†
                const { data: { text } } = await Tesseract.recognize(file, 'eng+chi_sim');
                let optimizedText = optimizeChineseText(text);
                const handWords = optimizedText
                    .split(/\n/)
                    .map(line => line.trim())
                    .filter(line => line.length >= 1);

                let correctCount = 0;
                let resultHtml = '';
                for (let i = 0; i < currentPureList.length; i++) {
                    const stdPhrase = currentUnit[i];
                    const handPhrase = handWords[i] || '<span style="color:#999">æœªå¡«å†™</span>';
                    const isCorrect = isCustomMode ? false : (currentPureList[i] === handPhrase.toLowerCase());
                    if (isCorrect) correctCount++;
                    resultHtml += `ç¬¬${i+1}é¢˜ï¼šæ ‡å‡†ã€${stdPhrase}ã€‘ â†’ ä½ çš„ã€${handPhrase}ã€‘ `;
                    if(isCustomMode) {
                        resultHtml += `<span>ï¼ˆè‡ªå®šä¹‰å†…å®¹ï¼‰</span><br>`;
                    } else {
                        resultHtml += `<span class="${isCorrect?'correct':'wrong'}">${isCorrect?'âœ… æ­£ç¡®':'âŒ é”™è¯¯'}</span><br>`;
                    }
                    resultHtml += '<br>';
                }

                let accuracyMsg = '';
                if(isCustomMode && customWordList.some(item => /[\u4e00-\u9fa5]/.test(item))) {
                    accuracyMsg = `ğŸ“ å…± ${currentPureList.length} æ¡å†…å®¹ï¼Œå·²æ˜¾ç¤ºä½ çš„å¬å†™ç»“æœã€‚`;
                } else {
                    const accuracy = Math.round((correctCount / currentPureList.length) * 100);
                    accuracyMsg = `ğŸ† æ‰¹æ”¹ç»“æœï¼šå…± ${currentPureList.length} é¢˜ï¼Œç­”å¯¹ ${correctCount} é¢˜ï¼Œæ­£ç¡®ç‡ ${accuracy}%ï¼`;
                }
                resultHtml += `<div class="accuracy">${accuracyMsg}</div>`;
                correctResult.innerHTML = resultHtml;
            } catch (err) {
                console.error('Check Error:', err);
                correctResult.innerHTML = '<p class="wrong">ğŸ˜¥ è¯†åˆ«å¤±è´¥ï¼Œè¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°ã€å…‰çº¿å……è¶³ã€‚</p>';
            }
        });

        // 6. å¼€å§‹å¬å†™
        startBtn.addEventListener('click', () => {
            if (!isRunning && currentUnit.length > 0) {
                isRunning = true;
                startBtn.disabled = true;
                confirmWordBtn.disabled = true;
                currentWordIndex = 0;
                const firstPhrase = currentUnit[currentWordIndex];
                wordDisplay.textContent = firstPhrase;
                readWordThreeTimes(firstPhrase);
                startTimer();
            }
        });

        // 7. é‡ç½®
        resetBtn.addEventListener('click', () => {
            clearInterval(timerInterval);
            window.speechSynthesis.cancel();
            isRunning = false;
            currentWordIndex = 0;
            timeLeft = 6;
            wordDisplay.textContent = "å‡†å¤‡å¼€å§‹å¬å†™å•¦ï½";
            timerDisplay.textContent = "6";
            startBtn.disabled = false;
            confirmWordBtn.disabled = customWordList.length === 0;
        });

        // 8. åˆ‡æ¢é»˜è®¤å•å…ƒ
        switchUnitBtn.addEventListener('click', () => {
            isCustomMode = false;
            currentUnit = currentUnit === unit1 ? unit2 : unit1;
            currentPureList = currentUnit === unit1 ? unit1Pure : unit2Pure;
            unitLabel.textContent = currentUnit === unit1 ? 'å½“å‰ï¼šæœè£…çŸ­è¯­å¬å†™' : 'å½“å‰ï¼šå¤‡ç”¨çŸ­è¯­å¬å†™';
            resetBtn.click();
            uploadPreview.style.display = 'none';
            checkPreview.style.display = 'none';
            correctResult.innerHTML = '';
            extractedWordTip.textContent = 'ç­‰å¾…æå–çŸ­è¯­ï½';
            wordFileInput.value = '';
            checkFileInput.value = '';
            uploadPhotoData = null;
            checkPhotoData = null;
            confirmWordBtn.disabled = true;
            checkBtn.disabled = true;
        });
    </script>
</body>
</html>